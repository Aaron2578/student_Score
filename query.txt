-- 1. Create profiles table
create table public.profiles (
  id uuid references auth.users on delete cascade primary key,
  username text unique,
  role text default 'student' check (role in ('admin', 'student')),
  designation text,
  total_marks int default 0,
  out_of int default 0,
  updated_at timestamp with time zone default now()
);

-- 2. Create feedbacks table
create table public.feedbacks (
  id bigint generated by default as identity primary key,
  student_username text,
  text text,
  rating int,
  designation text,
  visible boolean default false,
  created_at timestamp with time zone default now()
);

-- 3. Enable RLS
alter table public.profiles enable row level security;
alter table public.feedbacks enable row level security;

-- 4. Create policies
create policy "Profiles are viewable by everyone" on public.profiles for select using (true);
create policy "Users can update own profile" on public.profiles for update using (auth.uid() = id);
create policy "Public feedbacks are viewable by everyone" on public.feedbacks for select using (true);
create policy "Authenticated users can insert feedback" on public.feedbacks for insert with check (auth.role() = 'authenticated');
create policy "Admins can update feedbacks" on public.feedbacks for update using (true);
create policy "Admins can delete feedbacks" on public.feedbacks for delete using (true);


-- 5. FUNCTION & TRIGGER to automatically create profile on signup
-- This handles the "401 Unauthorized" issue when creating profiles from the frontend.
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, username, designation, role)
  values (
    new.id, 
    new.raw_user_meta_data->>'username', 
    new.raw_user_meta_data->>'designation',
    'student'
  );
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
